name: CI Tests

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  merge_group:

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.11'
      
      - name: Run Go unit tests
        run: go test -v -race -coverprofile=coverage.out ./...
      
      - name: Generate coverage report
        run: go tool cover -html=coverage.out -o coverage.html
      
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-coverage
          path: coverage.html
          if-no-files-found: ignore

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.11'
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install Python test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt
      
      - name: Run integration tests (fast)
        run: |
          pytest tests/ -v -m "not slow and not benchmark" --tb=short
      
      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: .pytest_cache/
          if-no-files-found: ignore

  benchmark-tests:
    name: Benchmark Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.11'
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install Python test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt
      
      - name: Run benchmark tests
        run: |
          pytest tests/ -v -m benchmark --benchmark-only --benchmark-json=benchmark-results.json
      
      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-results.json
          if-no-files-found: ignore
      
      - name: Display benchmark summary
        if: always()
        run: |
          if [ -f benchmark-results.json ]; then
            echo "Benchmark results saved to artifact"
            python -c "import json; data=json.load(open('benchmark-results.json')); print('\n=== Benchmark Summary ==='); [print(f\"{b['name']}: {b['stats']['mean']*1e6:.2f}Î¼s (mean)\") for b in data.get('benchmarks', [])]"
          fi

  slow-integration-tests:
    name: Slow Integration Tests (Network)
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    # Only run on main/develop branches to avoid rate limiting on PRs
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.11'
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install Python test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt
      
      - name: Run slow integration tests
        run: |
          pytest tests/ -v -m slow --timeout=300 --tb=short
        continue-on-error: true  # Don't fail the build if NVD API is slow/rate-limited
      
      - name: Upload slow test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: slow-integration-test-results
          path: .pytest_cache/
          if-no-files-found: ignore
