/**
 * CVEDetailModal Component
 * Displays detailed CVE information in a modal
 */

'use client';

import React, { useState, useCallback, useRef, useEffect } from 'react';
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import BookmarkStar from '@/components/bookmark-star';
import { generateURN } from '@/lib/utils';
import type { CVEItem } from "@/lib/types";
import { useViewLearnMode } from '@/contexts/ViewLearnContext';
import { ExpandAllIcon, CollapseAllIcon, CopyIcon } from '@/components/icons';
import { createLogger } from '@/lib/logger';

const logger = createLogger('cve-detail-modal');

interface CVEDetailModalProps {
  cve: CVEItem;
  onClose: () => void;
}

const getSeverityVariant = (score?: number): "default" | "secondary" | "destructive" | "outline" => {
  if (!score && score !== 0) return "outline";
  if (score >= 9.0) return "destructive";
  if (score >= 7.0) return "default";
  if (score >= 4.0) return "secondary";
  return "outline";
};

const getSeverityLabel = (score?: number): string => {
  if (!score && score !== 0) return "Unknown";
  if (score >= 9.0) return "Critical";
  if (score >= 7.0) return "High";
  if (score >= 4.0) return "Medium";
  return "Low";
};

const getSeverityColorHex = (score?: number): string => {
  if (!score && score !== 0) return '#9CA3AF';
  if (score >= 9.0) return '#ef4444';
  if (score >= 7.0) return '#f59e0b';
  if (score >= 4.0) return '#fbbf24';
  return '#10b981';
};

const getCVSSScore = (cve: CVEItem): number | undefined => {
  const metricLists = [
    cve.metrics?.cvssMetricV40,
    cve.metrics?.cvssMetricV31,
    (cve.metrics as any)?.cvssMetricV30 || (cve.metrics as any)?.cvssMetricV3,
    cve.metrics?.cvssMetricV2,
  ];

  let maxScore: number | undefined = undefined;
  for (const list of metricLists) {
    if (!Array.isArray(list)) continue;
    for (const item of list) {
      const s = item?.cvssData?.baseScore;
      if (typeof s === 'number') {
        if (maxScore === undefined || s > maxScore) maxScore = s;
      }
    }
    if (maxScore !== undefined) break;
  }
  return maxScore;
};

const getDescription = (cve: CVEItem): string => {
  const desc = cve.descriptions?.find(d => d.lang === 'en') || cve.descriptions?.[0];
  if (!desc) return 'No description available';
  const limit = 100;
  return desc.value.length > limit ? desc.value.substring(0, limit) + '...' : desc.value;
};

function MetricDetail({ m, metricKey, isOpen, onToggle, onCopy, copiedKeys }: { m: any; metricKey: string; isOpen: boolean; onToggle: () => void; onCopy: (text: string, key: string) => void; copiedKeys: Set<string> }) {
  const cvss = m?.cvssData || {};
  const title = `${cvss.version || ''}${cvss.baseSeverity ? ' — ' + cvss.baseSeverity : ''} — score: ${cvss.baseScore ?? 'N/A'}`;

  return (
    <details open={isOpen} className="bg-muted/10 rounded p-2">
      <summary
        className="cursor-pointer font-medium flex items-center justify-between"
        onClick={(e) => {
          e.preventDefault();
          onToggle();
        }}
      >
        <span className="flex items-center gap-2">
          <span className="inline-block w-2 h-2 rounded-sm" style={{ background: getSeverityColorHex(cvss.baseScore) }} />
          {title}
        </span>
        <span className="text-xs text-muted-foreground">{isOpen ? 'Hide' : 'Show'}</span>
      </summary>

      <div className="mt-2 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
        <div><strong>Base Score:</strong> {cvss.baseScore ?? 'N/A'}</div>
        <div><strong>Severity:</strong> {cvss.baseSeverity ?? 'N/A'}</div>
        <div className="col-span-2 flex items-center gap-2">
          <strong>Vector:</strong>
          <code className="wrap-break-word">{cvss.vectorString || 'N/A'}</code>
          {cvss.vectorString && (
            <Button variant="ghost" size="sm" className="ml-2" onClick={() => onCopy(cvss.vectorString, `${metricKey}-vector`)}>
              <CopyIcon className="h-4 w-4" />
            </Button>
          )}
          {copiedKeys.has(`${metricKey}-vector`) && <span className="text-xs text-success ml-2">Copied</span>}
        </div>
        <div><strong>Attack Vector:</strong> {cvss.attackVector || cvss.accessVector || 'N/A'}</div>
        <div><strong>Attack Complexity:</strong> {cvss.attackComplexity || cvss.accessComplexity || 'N/A'}</div>
        <div><strong>Privileges Required:</strong> {cvss.privilegesRequired ?? cvss.authentication ?? 'N/A'}</div>
        <div><strong>User Interaction:</strong> {cvss.userInteraction ?? 'N/A'}</div>
        <div><strong>Scope:</strong> {cvss.scope ?? 'N/A'}</div>
        <div><strong>Confidentiality:</strong> {cvss.confidentialityImpact ?? 'N/A'}</div>
        <div><strong>Integrity:</strong> {cvss.integrityImpact ?? 'N/A'}</div>
        <div><strong>Availability:</strong> {cvss.availabilityImpact ?? 'N/A'}</div>
        <div><strong>Exploitability Score:</strong> {m?.exploitabilityScore ?? 'N/A'}</div>
        <div><strong>Impact Score:</strong> {m?.impactScore ?? 'N/A'}</div>
        <div className="col-span-2"><strong>Source / Type:</strong> {m?.source || m?.type || 'N/A'}</div>
      </div>

      {m && (
        <div className="mt-2 text-xs text-muted-foreground">
          <div className="flex items-center justify-between">
            <div>Full metric object:</div>
            <div className="flex items-center gap-2">
              <Button variant="ghost" size="sm" onClick={() => onCopy(JSON.stringify(m, null, 2), `${metricKey}-json`)}>
                <CopyIcon className="h-4 w-4" />
              </Button>
              {copiedKeys.has(`${metricKey}-json`) && <span className="text-xs text-success">Copied</span>}
            </div>
          </div>
          <pre className="mt-1 bg-muted p-2 rounded text-xs overflow-x-auto">{JSON.stringify(m, null, 2)}</pre>
        </div>
      )}
    </details>
  );
}

export function CVEDetailModal({ cve, onClose }: CVEDetailModalProps) {
  const { mode } = useViewLearnMode();
  const isLearnMode = mode === 'learn';
  const [expandedKeys, setExpandedKeys] = useState<Set<string>>(new Set());
  const [copiedKeys, setCopiedKeys] = useState<Set<string>>(new Set());

  const handleCopy = useCallback(async (text: string, key: string) => {
    try {
      await navigator.clipboard.writeText(text);
      setCopiedKeys(prev => new Set(Array.from(prev).concat([key])));
      setTimeout(() => {
        setCopiedKeys(prev => {
          const next = new Set(prev);
          next.delete(key);
          return next;
        });
      }, 2000);
    } catch (e) {
      logger.error('Clipboard copy failed', e);
    }
  }, []);

  const toggleMetric = useCallback((metricKey: string) => {
    setExpandedKeys(prev => {
      const next = new Set(prev);
      if (next.has(metricKey)) next.delete(metricKey);
      else next.add(metricKey);
      return next;
    });
  }, []);

  const expandAll = useCallback(() => {
    const allKeys: string[] = [];
    Object.entries(cve.metrics || {}).forEach(([fam, list]: any) => {
      if (!Array.isArray(list)) return;
      list.forEach((_: any, idx: number) => allKeys.push(`${fam}-${idx}`));
    });
    setExpandedKeys(new Set(allKeys));
  }, [cve.metrics]);

  const collapseAll = useCallback(() => {
    setExpandedKeys(new Set());
  }, []);

  const cvssScore = getCVSSScore(cve);

  // Focus trap for modal
  const modalRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        onClose();
      }
      // Trap focus within modal
      if (e.key === 'Tab' && modalRef.current) {
        const focusableElements = modalRef.current.querySelectorAll(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        const firstElement = focusableElements[0] as HTMLElement;
        const lastElement = focusableElements[focusableElements.length - 1] as HTMLElement;
        
        if (e.shiftKey && document.activeElement === firstElement) {
          e.preventDefault();
          lastElement?.focus();
        } else if (!e.shiftKey && document.activeElement === lastElement) {
          e.preventDefault();
          firstElement?.focus();
        }
      }
    };

    if (modalRef.current) {
      document.addEventListener('keydown', handleKeyDown);
      // Focus the first focusable element when modal opens
      setTimeout(() => {
        const firstFocusable = modalRef.current?.querySelector(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        ) as HTMLElement;
        firstFocusable?.focus();
      }, 0);
    }

    return () => {
      document.removeEventListener('keydown', handleKeyDown);
    };
  }, [onClose]);

  return (
    <div
      ref={modalRef}
      role="dialog"
      aria-modal="true"
      aria-label={`CVE ${cve.id} details`}
      className="fixed inset-0 z-50 flex items-center justify-center p-4"
      onClick={onClose}
    >
      <div className="absolute inset-0 bg-black/40" onClick={onClose} aria-hidden="true" />

      <div
        className="relative max-w-4xl w-full bg-background rounded-lg shadow-lg p-6 overflow-auto max-h-[80vh]"
        onClick={(e) => e.stopPropagation()}
      >
        <Button
          variant="ghost"
          className="absolute top-4 right-4"
          onClick={onClose}
          aria-label="Close dialog"
        >
          <span className="sr-only">Close</span>
          ×
        </Button>

        <div className="mb-4 flex items-start justify-between gap-4">
          <div className="flex-1">
            <h2 className={`text-lg font-medium ${isLearnMode ? 'learn-enhanced' : ''}`}>{cve.id}</h2>
            <div className="mt-1 flex items-center gap-2">
              <Badge variant={getSeverityVariant(cvssScore)}>{getSeverityLabel(cvssScore)}</Badge>
              {cvssScore !== undefined && (
                <span className="text-sm text-muted-foreground">{cvssScore.toFixed(1)}</span>
              )}
              <span className="text-sm text-muted-foreground">• {cve.vulnStatus || 'Unknown status'}</span>
            </div>
          </div>

          <div className="text-sm text-muted-foreground flex flex-col items-end gap-2 shrink-0">
            <BookmarkStar
              itemId={cve.id}
              itemType="CVE"
              itemTitle={cve.id}
              itemDescription={getDescription(cve)}
              viewMode={mode}
            />
            <div className={isLearnMode ? 'learn-minimal' : ''}>Source: {cve.sourceIdentifier || (cve as any).source || 'Unknown'}</div>
            <div className={isLearnMode ? 'learn-minimal' : ''}>Published: {cve.published || 'N/A'}</div>
            <div className="mt-2 flex items-center gap-2">
              <Button variant="ghost" size="sm" onClick={expandAll} aria-label="Expand all metrics">
                <ExpandAllIcon className="h-4 w-4 mr-2" />
                Expand all
              </Button>
              <Button variant="ghost" size="sm" onClick={collapseAll} aria-label="Collapse all metrics">
                <CollapseAllIcon className="h-4 w-4 mr-2" />
                Collapse all
              </Button>
            </div>
          </div>
        </div>

        <section className={`mb-4 ${isLearnMode ? 'learn-enhanced' : ''}`}>
          <h3 className="font-semibold mb-2">Description (English)</h3>
          <p className="text-sm whitespace-pre-wrap">
            {(cve.descriptions || []).find((d:any) => d.lang === 'en')?.value || (cve.descriptions || [])[0]?.value || 'No description available'}
          </p>
        </section>

        <div className="mb-4">
          <div className="text-xs text-muted-foreground font-mono bg-muted px-2 py-1 rounded inline-block">
            URN: {generateURN('CVE', cve.id)}
          </div>
        </div>

        <section className="mb-4">
          <h3 className="font-semibold mb-2">Metrics</h3>
          <div className="text-sm space-y-2">
            {Object.entries(cve.metrics || {}).map(([key, list]: any) => {
              if (!Array.isArray(list) || list.length === 0) return null;
              return (
                <div key={key} className="space-y-2">
                  <div className="font-medium mb-1">{key}</div>
                  {list.map((m: any, idx: number) => {
                    const metricKey = `${key}-${idx}`;
                    const isOpen = expandedKeys.has(metricKey);
                    return (
                      <MetricDetail
                        key={idx}
                        m={m}
                        metricKey={metricKey}
                        isOpen={isOpen}
                        onToggle={() => toggleMetric(metricKey)}
                        onCopy={handleCopy}
                        copiedKeys={copiedKeys}
                      />
                    );
                  })}
                </div>
              );
            })}
          </div>
        </section>

        <section className="mb-4">
          <h3 className="font-semibold mb-2">References</h3>
          <ul className="ml-4 list-disc text-sm">
            {(cve.references || []).slice(0, 20).map((r: any, i: number) => (
              <li key={i}><a href={r.url} target="_blank" rel="noreferrer" className="text-primary underline">{r.url}</a></li>
            ))}
            {(cve.references || []).length === 0 && <li>No references</li>}
          </ul>
        </section>

        <section className="mb-4">
          <h3 className="font-semibold mb-2">Weaknesses</h3>
          <ul className="ml-4 list-disc text-sm">
            {(cve.weaknesses || []).flatMap((w:any) => w.description || []).map((d:any, i:number) => (
              <li key={i}>{d.value}</li>
            ))}
            {(cve.weaknesses || []).length === 0 && <li>No weaknesses listed</li>}
          </ul>
        </section>

        <details className="mt-4 text-sm">
          <summary className="cursor-pointer">Raw JSON</summary>
          <pre className="text-xs mt-2 overflow-x-auto bg-muted p-2 rounded">{JSON.stringify(cve, null, 2)}</pre>
        </details>
      </div>
    </div>
  );
}
