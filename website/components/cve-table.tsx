/**
 * CVE Table Component
 * Displays CVE data with pagination and filtering
 */

'use client';

import React, { memo, useMemo, useCallback, useRef } from 'react';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";
import { ChevronLeftIcon as ChevronLeft, ChevronRightIcon as ChevronRight, EyeIcon as Eye } from '@/components/icons';
import { useVirtualizer } from '@tanstack/react-virtual';

import type { CVEItem } from "@/lib/types";

interface CVETableProps {
  cves: CVEItem[];
  total: number;
  page: number;
  pageSize: number;
  isLoading: boolean;
  onPageChange: (page: number) => void;
  onPageSizeChange: (pageSize: number) => void;
  searchQuery?: string;
}

// Helper utilities extracted to module scope so they're not recreated on each render
const getSeverityVariant = (score?: number): "default" | "secondary" | "destructive" | "outline" => {
  if (!score && score !== 0) return "outline";
  if (score >= 9.0) return "destructive";
  if (score >= 7.0) return "default";
  if (score >= 4.0) return "secondary";
  return "outline";
};

const getSeverityLabel = (score?: number): string => {
  if (!score && score !== 0) return "Unknown";
  if (score >= 9.0) return "Critical";
  if (score >= 7.0) return "High";
  if (score >= 4.0) return "Medium";
  return "Low";
};

const getCVSSScore = (cve: CVEItem): number | undefined => {
  if (cve.metrics?.cvssMetricV31?.[0]?.cvssData?.baseScore) {
    return cve.metrics.cvssMetricV31[0].cvssData.baseScore;
  }
  if (cve.metrics?.cvssMetricV30?.[0]?.cvssData?.baseScore) {
    return cve.metrics.cvssMetricV30[0].cvssData.baseScore;
  }
  if (cve.metrics?.cvssMetricV2?.[0]?.cvssData?.baseScore) {
    return cve.metrics.cvssMetricV2[0].cvssData.baseScore;
  }
  return undefined;
};

const getDescription = (cve: CVEItem): string => {
  const desc = cve.descriptions?.find(d => d.lang === 'en');
  if (!desc) return 'No description available';
  return desc.value.length > 200
    ? desc.value.substring(0, 200) + '...'
    : desc.value;
};

export const CVETable = memo(function CVETable({
  cves,
  total,
  page,
  pageSize,
  isLoading,
  onPageChange,
  searchQuery,
}: CVETableProps) {
  // Memoize pagination numbers to avoid recomputing on unrelated state updates
  const totalPages = useMemo(() => Math.max(1, Math.ceil(total / pageSize)), [total, pageSize]);
  const startIndex = useMemo(() => page * pageSize + 1, [page, pageSize, total]);
  const endIndex = useMemo(() => Math.min((page + 1) * pageSize, total), [page, pageSize, total]);

  // Apply local search filter to the currently loaded CVEs (server search not implemented)
  const filtered = useMemo(() => {
    if (!searchQuery) return cves;
    const q = searchQuery.trim().toLowerCase();
    if (!q) return cves;
    return cves.filter((c) => {
      const desc = (c.descriptions?.find(d => d.lang === 'en')?.value || '').toLowerCase();
      return c.id.toLowerCase().includes(q) || desc.includes(q);
    });
  }, [cves, searchQuery]);

  // Precompute derived row fields so rendering is cheaper
  const rows = useMemo(() => {
    return filtered.map((cve) => ({
      id: cve.id,
      score: getCVSSScore(cve),
      description: getDescription(cve),
      published: cve.published ? new Date(cve.published).toLocaleDateString() : 'N/A',
      raw: cve,
    }));
  }, [filtered]);

  // Virtualization setup
  const parentRef = useRef<HTMLDivElement | null>(null);
  const rowVirtualizer = useVirtualizer({
    count: rows.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 80,
    overscan: 5,
  });

  const handlePrev = useCallback(() => {
    onPageChange(Math.max(0, page - 1));
  }, [onPageChange, page]);

  const handleNext = useCallback(() => {
    onPageChange(Math.min(totalPages - 1, page + 1));
  }, [onPageChange, page, totalPages]);

  if (isLoading) {
    return (
      <div className="space-y-4">
        {[...Array(5)].map((_, i) => (
          <Skeleton key={i} className="h-20 w-full" />
        ))}
      </div>
    );
  }

  if (rows.length === 0) {
    return (
      <div className="text-center py-12">
        <p className="text-muted-foreground">No CVE records found</p>
        <p className="text-sm text-muted-foreground mt-2">
          Start a session to fetch CVE data from NVD
        </p>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      <div className="rounded-md border">
        {/* Header as grid to align with virtual rows */}
        <div className="hidden md:grid grid-cols-[140px_120px_1fr_140px_100px] gap-x-4 px-4 py-2 border-b text-sm font-medium text-muted-foreground">
          <div>CVE ID</div>
          <div>Severity</div>
          <div>Description</div>
          <div>Published</div>
          <div>Actions</div>
        </div>

        {/* Virtualized scroll area: only this element scrolls */}
        <div ref={parentRef} className="max-h-[56vh] overflow-auto">
          <div style={{ height: rowVirtualizer.getTotalSize(), position: 'relative' }}>
            {rowVirtualizer.getVirtualItems().map((virtualRow: any) => {
              const row = rows[virtualRow.index];
              return (
                <div
                  key={row.id}
                  role="row"
                  style={{
                    position: 'absolute',
                    top: virtualRow.start,
                    left: 0,
                    right: 0,
                    width: '100%',
                  }}
                  className="grid grid-cols-[140px_120px_1fr_140px_100px] gap-x-4 items-center px-4 py-3 border-b bg-background"
                >
                  <div className="font-mono font-medium">{row.id}</div>
                  <div>
                    <div className="flex flex-col gap-1">
                      <Badge variant={getSeverityVariant(row.score)}>{getSeverityLabel(row.score)}</Badge>
                      {row.score !== undefined && (
                        <span className="text-xs text-muted-foreground">{row.score.toFixed(1)}</span>
                      )}
                    </div>
                  </div>
                  <div className="max-w-md">
                    <p className="text-sm line-clamp-2">{row.description}</p>
                  </div>
                  <div className="text-sm text-muted-foreground">{row.published}</div>
                  <div>
                    <Button variant="ghost" size="sm" className="cursor-pointer">
                      <Eye className="h-4 w-4 mr-1" />
                      View
                    </Button>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      </div>

      {/* Pagination */}
      <div className="flex items-center justify-between">
        <p className="text-sm text-muted-foreground">
          Showing {startIndex} to {Math.min(endIndex, page * pageSize + rows.length)} of {total} results (showing {rows.length} on this page)
        </p>
        <div className="flex items-center gap-2">
          <Button variant="outline" size="sm" onClick={handlePrev} disabled={page === 0} className="cursor-pointer">
            <ChevronLeft className="h-4 w-4" />
            Previous
          </Button>
          <div className="text-sm">Page {page + 1} of {totalPages}</div>
          <Button variant="outline" size="sm" onClick={handleNext} disabled={page >= totalPages - 1} className="cursor-pointer">
            Next
            <ChevronRight className="h-4 w-4" />
          </Button>
        </div>
      </div>
    </div>
  );
});
