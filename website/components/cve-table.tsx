/**
 * CVE Table Component
 * Displays CVE data with pagination and filtering
 */

'use client';

import React, { memo, useMemo, useCallback, useRef, useState, useEffect } from 'react';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";
import { ChevronLeftIcon as ChevronLeft, ChevronRightIcon as ChevronRight, EyeIcon as Eye, CopyIcon, ExpandAllIcon, CollapseAllIcon } from '@/components/icons';
import { useVirtualizer } from '@tanstack/react-virtual';

import type { CVEItem } from "@/lib/types";

interface CVETableProps {
  cves: CVEItem[];
  total: number;
  page: number;
  pageSize: number;
  isLoading: boolean;
  onPageChange: (page: number) => void;
  onPageSizeChange: (pageSize: number) => void;
  searchQuery?: string;
}

// Helper utilities extracted to module scope so they're not recreated on each render
const getSeverityVariant = (score?: number): "default" | "secondary" | "destructive" | "outline" => {
  if (!score && score !== 0) return "outline";
  if (score >= 9.0) return "destructive";
  if (score >= 7.0) return "default";
  if (score >= 4.0) return "secondary";
  return "outline";
};

const getSeverityLabel = (score?: number): string => {
  if (!score && score !== 0) return "Unknown";
  if (score >= 9.0) return "Critical";
  if (score >= 7.0) return "High";
  if (score >= 4.0) return "Medium";
  return "Low";
};

// Map severity to a small color for subtle row accent (hex colors to avoid depending on Tailwind palette variations)
const getSeverityColorHex = (score?: number): string => {
  if (!score && score !== 0) return '#9CA3AF'; // gray-400
  if (score >= 9.0) return '#ef4444'; // red-500
  if (score >= 7.0) return '#f59e0b'; // amber-500 (high)
  if (score >= 4.0) return '#fbbf24'; // yellow-400 (medium)
  return '#10b981'; // green-500 (low)
};

// Prefer newer metrics (4.0 -> 3.1 -> 3.0 -> 2.0) and return the highest baseScore available
const getCVSSScore = (cve: CVEItem): number | undefined => {
  const metricLists = [
    cve.metrics?.cvssMetricV40,
    cve.metrics?.cvssMetricV31,
    // some payloads may use cvssMetricV3 or cvssMetricV30
    (cve.metrics as any)?.cvssMetricV30 || (cve.metrics as any)?.cvssMetricV3,
    cve.metrics?.cvssMetricV2,
  ];

  let maxScore: number | undefined = undefined;
  for (const list of metricLists) {
    if (!Array.isArray(list)) continue;
    for (const item of list) {
      const s = item?.cvssData?.baseScore;
      if (typeof s === 'number') {
        if (maxScore === undefined || s > maxScore) maxScore = s;
      }
    }
    // if we already found a score from a higher-preference metric family, prefer it
    if (maxScore !== undefined) break;
  }
  return maxScore;
};

const getDescription = (cve: CVEItem): string => {
  const desc = cve.descriptions?.find(d => d.lang === 'en') || cve.descriptions?.[0];
  if (!desc) return 'No description available';
  // List view should show a concise summary (shorter for better table fit)
  const limit = 100;
  return desc.value.length > limit ? desc.value.substring(0, limit) + '...' : desc.value;
};

export const CVETable = memo(function CVETable({
  cves,
  total,
  page,
  pageSize,
  isLoading,
  onPageChange,
  searchQuery,
}: CVETableProps) {
  const [selected, setSelected] = useState<any>(null);

  // State for metric expand/collapse controls and copy confirmations
  const [expandedKeys, setExpandedKeys] = useState<Set<string>>(new Set());
  const [copiedKeys, setCopiedKeys] = useState<Set<string>>(new Set());

  // Memoize pagination numbers to avoid recomputing on unrelated state updates
  const totalPages = useMemo(() => Math.max(1, Math.ceil(total / pageSize)), [total, pageSize]);
  const startIndex = useMemo(() => page * pageSize + 1, [page, pageSize, total]);
  const endIndex = useMemo(() => Math.min((page + 1) * pageSize, total), [page, pageSize, total]);

  // Apply local search filter to the currently loaded CVEs (server search not implemented)
  const filtered = useMemo(() => {
    if (!searchQuery) return cves;
    const q = searchQuery.trim().toLowerCase();
    if (!q) return cves;
    return cves.filter((c) => {
      const desc = (c.descriptions?.find(d => d.lang === 'en')?.value || '').toLowerCase();
      return c.id.toLowerCase().includes(q) || desc.includes(q);
    });
  }, [cves, searchQuery]);

  // Precompute derived row fields so rendering is cheaper
  const rows = useMemo(() => {
    return filtered.map((cve) => ({
      id: cve.id,
      score: getCVSSScore(cve),
      description: getDescription(cve),
      published: cve.published ? new Date(cve.published).toLocaleDateString() : 'N/A',
      lastModified: cve.lastModified ? new Date(cve.lastModified).toLocaleDateString() : undefined,
      source: cve.sourceIdentifier || (cve as any).source || 'Unknown',
      status: cve.vulnStatus || 'Unknown',
      references: cve.references || [],
      weaknesses: cve.weaknesses || [],
      raw: cve,
    }));
  }, [filtered]);

  // Virtualization setup
  const parentRef = useRef<HTMLDivElement | null>(null);
  const rowVirtualizer = useVirtualizer({
    count: rows.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 80,
    overscan: 5,
  });

  const handlePrev = useCallback(() => {
    onPageChange(Math.max(0, page - 1));
  }, [onPageChange, page]);

  const handleNext = useCallback(() => {
    onPageChange(Math.min(totalPages - 1, page + 1));
  }, [onPageChange, page, totalPages]);

  // Clipboard helper (shows a brief copied confirmation)
  const handleCopy = async (text: string, key: string) => {
    try {
      await navigator.clipboard.writeText(text);
      setCopiedKeys(prev => new Set(Array.from(prev).concat([key])));
      // remove confirmation after 2s
      setTimeout(() => {
        setCopiedKeys(prev => {
          const next = new Set(prev);
          next.delete(key);
          return next;
        });
      }, 2000);
    } catch (e) {
      // ignore clipboard failures silently for now
      console.error('copy failed', e);
    }
  };

  if (isLoading) {
    return (
      <div className="space-y-4">
        {[...Array(5)].map((_, i) => (
          <Skeleton key={i} className="h-20 w-full" />
        ))}
      </div>
    );
  }

  if (rows.length === 0) {
    return (
      <div className="text-center py-12">
        <p className="text-muted-foreground">No CVE records found</p>
        <p className="text-sm text-muted-foreground mt-2">
          Start a session to fetch CVE data from NVD
        </p>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      <div className="rounded-md border">
        {/* Header as grid to align with virtual rows */}
        <div className="hidden md:grid grid-cols-[140px_120px_1fr_120px_160px_120px_100px] gap-x-4 px-4 py-2 border-b text-sm font-medium text-muted-foreground">
          <div>CVE ID</div>
          <div>Severity</div>
          <div>Description</div>
          <div>Published</div>
          <div>Source</div>
          <div>Status</div>
          <div>Actions</div>
        </div>

        {/* Virtualized scroll area: only this element scrolls */}
        <div ref={parentRef} className="max-h-[56vh] overflow-auto">
          <div style={{ height: rowVirtualizer.getTotalSize(), position: 'relative' }}>
            {rowVirtualizer.getVirtualItems().map((virtualRow: any) => {
              const row = rows[virtualRow.index];
              const borderColor = getSeverityColorHex(row.score);
              return (
                <div
                  key={row.id}
                  role="row"
                  style={{
                    position: 'absolute',
                    top: virtualRow.start,
                    left: 0,
                    right: 0,
                    width: '100%',
                    borderLeft: `4px solid ${borderColor}`,
                  }}
                  className="grid grid-cols-[140px_120px_1fr_120px_160px_120px_100px] gap-x-4 items-center px-4 py-3 border-b bg-background z-10"
                >
                  <div className="font-mono font-medium">{row.id}</div>
                  <div>
                    <div className="flex flex-col gap-1">
                      <Badge variant={getSeverityVariant(row.score)}>{getSeverityLabel(row.score)}</Badge>
                      {row.score !== undefined && (
                        <span className="text-xs text-muted-foreground">{row.score.toFixed(1)}</span>
                      )}
                    </div>
                  </div>
                  <div className="max-w-md">
                    <p className="text-sm line-clamp-2">{row.description}</p>
                  </div>
                  <div className="text-sm text-muted-foreground">{row.published}</div>
                  <div className="text-sm">{row.source}</div>
                  <div className="text-sm">
                    <span className="inline-block align-middle">{row.status}</span>
                  </div>
                  <div>
                    <Button
                      type="button"
                      variant="ghost"
                      size="sm"
                      className="cursor-pointer"
                      aria-label={`View ${row.id} details`}
                      onClick={() => setSelected(row.raw)}
                    >
                      <Eye className="h-4 w-4 mr-1" />
                      View
                    </Button>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      </div>

      {/* Pagination */}
      <div className="flex items-center justify-between">
        <p className="text-sm text-muted-foreground">
          Showing {startIndex} to {Math.min(endIndex, page * pageSize + rows.length)} of {total} results (showing {rows.length} on this page)
        </p>
        <div className="flex items-center gap-2">
          <Button variant="outline" size="sm" onClick={handlePrev} disabled={page === 0} className="cursor-pointer">
            <ChevronLeft className="h-4 w-4" />
            Previous
          </Button>
          <div className="text-sm">Page {page + 1} of {totalPages}</div>
          <Button variant="outline" size="sm" onClick={handleNext} disabled={page >= totalPages - 1} className="cursor-pointer">
            Next
            <ChevronRight className="h-4 w-4" />
          </Button>
        </div>
      </div>

      {/* Modal for CVE details (structured view) */}
      {selected && (
        <div
          role="dialog"
          aria-modal="true"
          className="fixed inset-0 z-50 flex items-center justify-center p-4"
          onClick={() => setSelected(null)}
        >
          {/* mask to capture clicks */}
          <div className="absolute inset-0 bg-black/40" onClick={() => setSelected(null)} aria-hidden="true" />

          <div
            className="relative max-w-4xl w-full bg-background rounded-lg shadow-lg p-6 overflow-auto max-h-[80vh]"
            onClick={(e) => e.stopPropagation()}
          >
            <Button
              variant="ghost"
              className="absolute top-4 right-4"
              onClick={() => setSelected(null)}
            >
              <span className="sr-only">Close</span>
              &times;
            </Button>

            <div className="mb-4 flex items-start justify-between gap-4">
              <div>
                <h2 className="text-lg font-medium">{selected.id}</h2>
                <div className="mt-1 flex items-center gap-2">
                  <Badge variant={getSeverityVariant(getCVSSScore(selected))}>{getSeverityLabel(getCVSSScore(selected))}</Badge>
                  {getCVSSScore(selected) !== undefined && (
                    <span className="text-sm text-muted-foreground">{getCVSSScore(selected)!.toFixed(1)}</span>
                  )}
                  <span className="text-sm text-muted-foreground">• {selected.vulnStatus || 'Unknown status'}</span>
                </div>
              </div>

              <div className="text-sm text-muted-foreground flex flex-col items-end gap-2">
                <div>Source: {selected.sourceIdentifier || selected.source || 'Unknown'}</div>
                <div>Published: {selected.published || selected.publishedDate || 'N/A'}</div>
                {/* Expand/Collapse controls for metrics */}
                <div className="mt-2 flex items-center gap-2">
                  <Button variant="ghost" size="sm" onClick={() => {
                    // expand all: gather keys and populate expandedKeys
                    const allKeys: string[] = [];
                    Object.entries(selected.metrics || {}).forEach(([fam, list]: any) => {
                      if (!Array.isArray(list)) return;
                      list.forEach((_: any, idx: number) => allKeys.push(`${fam}-${idx}`));
                    });
                    setExpandedKeys(new Set(allKeys));
                  }} aria-label="Expand all metrics">
                    <ExpandAllIcon className="h-4 w-4 mr-2" />
                    Expand all
                  </Button>

                  <Button variant="ghost" size="sm" onClick={() => setExpandedKeys(new Set())} aria-label="Collapse all metrics">
                    <CollapseAllIcon className="h-4 w-4 mr-2" />
                    Collapse all
                  </Button>
                </div>
              </div>
            </div>

            <section className="mb-4">
              <h3 className="font-semibold mb-2">Description (English)</h3>
              <p className="text-sm whitespace-pre-wrap">
                { (selected.descriptions || []).find((d:any) => d.lang === 'en')?.value || (selected.descriptions || [])[0]?.value || 'No description available' }
              </p>
            </section>

            <section className="mb-4">
              <h3 className="font-semibold mb-2">Metrics</h3>
              <div className="text-sm space-y-2">
                {Object.entries(selected.metrics || {}).map(([key, list]: any) => {
                  if (!Array.isArray(list) || list.length === 0) return null;
                  return (
                    <div key={key} className="space-y-2">
                      <div className="font-medium mb-1">{key}</div>
                      {list.map((m: any, idx: number) => {
                        const cvss = m?.cvssData || {};
                        const title = `${cvss.version || ''}${cvss.baseSeverity ? ' — ' + cvss.baseSeverity : ''} — score: ${cvss.baseScore ?? 'N/A'}`;
                        const metricKey = `${key}-${idx}`;
                        const isOpen = expandedKeys.has(metricKey);
                        return (
                          <details key={idx} open={isOpen} className="bg-muted/10 rounded p-2">
                            <summary
                              className="cursor-pointer font-medium flex items-center justify-between"
                              onClick={(e) => {
                                e.preventDefault();
                                setExpandedKeys(prev => {
                                  const next = new Set(prev);
                                  if (next.has(metricKey)) next.delete(metricKey);
                                  else next.add(metricKey);
                                  return next;
                                });
                              }}
                            >
                              <span className="flex items-center gap-2">
                                <span className="inline-block w-2 h-2 rounded-sm" style={{ background: getSeverityColorHex(cvss.baseScore) }} />
                                {title}
                              </span>
                              <span className="text-xs text-muted-foreground">{isOpen ? 'Hide' : 'Show'}</span>
                            </summary>

                            <div className="mt-2 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                              <div><strong>Base Score:</strong> {cvss.baseScore ?? 'N/A'}</div>
                              <div><strong>Severity:</strong> {cvss.baseSeverity ?? 'N/A'}</div>
                              <div className="col-span-2 flex items-center gap-2"><strong>Vector:</strong> <code className="wrap-break-word">{cvss.vectorString || 'N/A'}</code>
                                {cvss.vectorString && (
                                  <Button variant="ghost" size="sm" className="ml-2" onClick={() => handleCopy(cvss.vectorString, `${metricKey}-vector`)} aria-label={`Copy vector for ${metricKey}`}>
                                    <CopyIcon className="h-4 w-4" />
                                  </Button>
                                )}
                                {copiedKeys.has(`${metricKey}-vector`) && <span className="text-xs text-success ml-2">Copied</span>}
                              </div>
                              <div><strong>Attack Vector:</strong> {cvss.attackVector || cvss.accessVector || 'N/A'}</div>
                              <div><strong>Attack Complexity:</strong> {cvss.attackComplexity || cvss.accessComplexity || 'N/A'}</div>
                              <div><strong>Privileges Required:</strong> {cvss.privilegesRequired ?? cvss.authentication ?? 'N/A'}</div>
                              <div><strong>User Interaction:</strong> {cvss.userInteraction ?? 'N/A'}</div>
                              <div><strong>Scope:</strong> {cvss.scope ?? 'N/A'}</div>
                              <div><strong>Confidentiality:</strong> {cvss.confidentialityImpact ?? 'N/A'}</div>
                              <div><strong>Integrity:</strong> {cvss.integrityImpact ?? 'N/A'}</div>
                              <div><strong>Availability:</strong> {cvss.availabilityImpact ?? 'N/A'}</div>
                              <div><strong>Exploitability Score:</strong> {m?.exploitabilityScore ?? 'N/A'}</div>
                              <div><strong>Impact Score:</strong> {m?.impactScore ?? 'N/A'}</div>
                              <div className="col-span-2"><strong>Source / Type:</strong> {m?.source || m?.type || 'N/A'}</div>
                            </div>

                            {m && (
                              <div className="mt-2 text-xs text-muted-foreground">
                                <div className="flex items-center justify-between">
                                  <div>Full metric object:</div>
                                  <div className="flex items-center gap-2">
                                    <Button variant="ghost" size="sm" onClick={() => handleCopy(JSON.stringify(m, null, 2), `${metricKey}-json`)} aria-label={`Copy metric JSON for ${metricKey}`}>
                                      <CopyIcon className="h-4 w-4" />
                                    </Button>
                                    {copiedKeys.has(`${metricKey}-json`) && <span className="text-xs text-success">Copied</span>}
                                  </div>
                                </div>
                                <pre className="mt-1 bg-muted p-2 rounded text-xs overflow-x-auto">{JSON.stringify(m, null, 2)}</pre>
                              </div>
                            )}
                          </details>
                        );
                      })}
                    </div>
                  );
                })}
              </div>
             </section>

            <section className="mb-4">
              <h3 className="font-semibold mb-2">References</h3>
              <ul className="ml-4 list-disc text-sm">
                {(selected.references || []).slice(0, 20).map((r: any, i: number) => (
                  <li key={i}><a href={r.url} target="_blank" rel="noreferrer" className="text-primary underline">{r.url}</a></li>
                ))}
                { (selected.references || []).length === 0 && <li>No references</li> }
              </ul>
            </section>

            <section className="mb-4">
              <h3 className="font-semibold mb-2">Weaknesses</h3>
              <ul className="ml-4 list-disc text-sm">
                {(selected.weaknesses || []).flatMap((w:any) => w.description || []).map((d:any, i:number) => (
                  <li key={i}>{d.value}</li>
                ))}
                { (selected.weaknesses || []).length === 0 && <li>No weaknesses listed</li> }
              </ul>
            </section>

            <details className="mt-4 text-sm">
              <summary className="cursor-pointer">Raw JSON</summary>
              <pre className="text-xs mt-2 overflow-x-auto bg-muted p-2 rounded">{JSON.stringify(selected, null, 2)}</pre>
            </details>
          </div>
        </div>
      )}
    </div>
  );
});
