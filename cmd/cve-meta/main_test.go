package main

import (
	"context"
	"encoding/json"
	"os"
	"path/filepath"
	"testing"
	"time"

	"github.com/cyw0ng95/v2e/pkg/proc/subprocess"
)

// TestRPCGetRemoteCVECount tests the RPCGetRemoteCVECount handler
func TestRPCGetRemoteCVECount(t *testing.T) {
	// Create a temporary database file
	tmpDir := t.TempDir()
	dbPath := filepath.Join(tmpDir, "test_count_cve.db")
	os.Setenv("CVE_DB_PATH", dbPath)
	defer os.Unsetenv("CVE_DB_PATH")

	// Initialize services
	broker, err := initializeServices(dbPath)
	if err != nil {
		t.Fatalf("Failed to initialize services: %v", err)
	}
	defer broker.Shutdown()

	// Check process status
	time.Sleep(3 * time.Second)
	processes := broker.ListProcesses()
	t.Logf("Active processes: %d", len(processes))
	for _, p := range processes {
		t.Logf("Process %s: PID=%d Status=%s", p.ID, p.PID, p.Status)
	}

	// Create request message
	req := &subprocess.Message{
		Type:    subprocess.MessageTypeRequest,
		ID:      "RPCGetRemoteCVECount",
		Payload: json.RawMessage("{}"),
	}

	// Create a channel to capture the response
	responseChan := make(chan *subprocess.Message, 1)

	// Call handler
	handler := createGetRemoteCVECountHandler(broker)
	go func() {
		ctx, cancel := context.WithTimeout(context.Background(), 60*time.Second)
		defer cancel()
		
		resp, err := handler(ctx, req)
		if err != nil {
			t.Errorf("Handler returned error: %v", err)
			return
		}
		responseChan <- resp
	}()

	// Wait for response
	select {
	case resp := <-responseChan:
		if resp.Type != subprocess.MessageTypeResponse {
			t.Errorf("Expected response message, got %s", resp.Type)
		}

		// Parse response
		var result map[string]interface{}
		if err := json.Unmarshal(resp.Payload, &result); err != nil {
			t.Fatalf("Failed to parse response: %v", err)
		}

		t.Logf("Count response: %+v", result)

		// Verify total_results field exists and is > 0
		if totalResults, ok := result["total_results"].(float64); ok {
			if totalResults <= 0 {
				t.Errorf("Expected total_results > 0, got %f", totalResults)
			}
			t.Logf("Total CVEs in NVD: %d", int(totalResults))
		} else {
			t.Error("total_results field not found in response")
		}

	case <-time.After(70 * time.Second):
		t.Fatal("Timeout waiting for count response")
	}
}
