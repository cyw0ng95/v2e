package main

import (
"context"
"flag"
"os"
"path/filepath"
"time"

"github.com/cyw0ng95/v2e/pkg/common"
"github.com/cyw0ng95/v2e/pkg/proc"
)

func main() {
// Parse command line flags
cveID := flag.String("cve-id", "CVE-2021-44228", "CVE ID to fetch and store")
dbPath := flag.String("db", "cve.db", "Path to CVE database")
batchMode := flag.Bool("batch", false, "Run in batch mode (fetch multiple CVEs)")
flag.Parse()

// Set up logger
common.SetLevel(common.InfoLevel)
logger := common.NewLogger(os.Stdout, "[CLIENT] ", common.InfoLevel)

// Create broker
broker := proc.NewBroker()
broker.SetLogger(logger)
defer broker.Shutdown()

// Get the path to the built binaries
exePath, err := os.Executable()
if err != nil {
common.Error("Failed to get executable path: %v", err)
os.Exit(1)
}
baseDir := filepath.Dir(exePath)

// Set environment variable for database path
os.Setenv("CVE_DB_PATH", *dbPath)

// Spawn CVE meta service
common.Info("Starting CVE meta service...")
cveMetaPath := filepath.Join(baseDir, "cve-meta")
if _, err := os.Stat(cveMetaPath); os.IsNotExist(err) {
cveMetaPath = "go"
_, err = broker.SpawnRPC("cve-meta", cveMetaPath, "run", "./cmd/cve-meta")
} else {
_, err = broker.SpawnRPC("cve-meta", cveMetaPath)
}
if err != nil {
common.Error("Failed to spawn cve-meta: %v", err)
os.Exit(1)
}

// Wait for service to be ready
common.Info("Waiting for CVE meta service to be ready...")
time.Sleep(5 * time.Second)

if *batchMode {
// Batch mode - fetch multiple CVEs
common.Info("Fetching multiple CVEs in batch mode...")
batchMsg, _ := proc.NewRequestMessage("RPCBatchFetchCVEs", map[string]interface{}{
"cve_ids": []string{"CVE-2021-44228", "CVE-2024-1234", "CVE-2023-12345"},
})
if err := broker.SendToProcess("cve-meta", batchMsg); err != nil {
common.Error("Failed to send batch message: %v", err)
os.Exit(1)
}

// Wait for batch response
ctx, cancel := context.WithTimeout(context.Background(), 120*time.Second)
defer cancel()

for {
msg, err := broker.ReceiveMessage(ctx)
if err != nil {
common.Error("Failed to receive batch response: %v", err)
os.Exit(1)
}

if msg.Type == proc.MessageTypeResponse && msg.ID == "RPCBatchFetchCVEs" {
var resp map[string]interface{}
if err := msg.UnmarshalPayload(&resp); err == nil {
common.Info("Batch fetch completed: %+v", resp)
if results, ok := resp["results"].([]interface{}); ok {
for i, r := range results {
resultMap := r.(map[string]interface{})
common.Info("CVE %d: %+v", i+1, resultMap)
}
}
}
break
}

// Handle event messages
if msg.Type == proc.MessageTypeEvent {
var event map[string]interface{}
if err := msg.UnmarshalPayload(&event); err == nil {
eventType := event["event"]
if eventType != nil {
common.Debug("Event: %v", eventType)
}
}
}
}
} else {
// Single CVE mode
common.Info("Fetching CVE %s...", *cveID)
fetchMsg, _ := proc.NewRequestMessage("RPCFetchAndStoreCVE", map[string]string{
"cve_id": *cveID,
})
if err := broker.SendToProcess("cve-meta", fetchMsg); err != nil {
common.Error("Failed to send fetch message: %v", err)
os.Exit(1)
}

// Wait for response
ctx, cancel := context.WithTimeout(context.Background(), 60*time.Second)
defer cancel()

for {
msg, err := broker.ReceiveMessage(ctx)
if err != nil {
common.Error("Failed to receive message: %v", err)
os.Exit(1)
}

if msg.Type == proc.MessageTypeResponse && msg.ID == "RPCFetchAndStoreCVE" {
var resp map[string]interface{}
if err := msg.UnmarshalPayload(&resp); err == nil {
common.Info("Fetch completed: %+v", resp)
if alreadyStored, ok := resp["already_stored"].(bool); ok && alreadyStored {
common.Info("CVE %s was already stored locally", *cveID)
} else if fetched, ok := resp["fetched"].(bool); ok && fetched {
common.Info("Successfully fetched and stored CVE %s", *cveID)
}
}
break
}

// Handle event messages
if msg.Type == proc.MessageTypeEvent {
var event map[string]interface{}
if err := msg.UnmarshalPayload(&event); err == nil {
eventType := event["event"]
if eventType != nil {
common.Debug("Event: %v", eventType)
}
}
}
}

// Get CVE count from remote
common.Info("Getting total CVE count from NVD...")
cntMsg, _ := proc.NewRequestMessage("RPCGetRemoteCVECount", map[string]interface{}{})
if err := broker.SendToProcess("cve-meta", cntMsg); err != nil {
common.Error("Failed to send count message: %v", err)
os.Exit(1)
}

// Wait for count response
ctx2, cancel2 := context.WithTimeout(context.Background(), 60*time.Second)
defer cancel2()

for {
msg, err := broker.ReceiveMessage(ctx2)
if err != nil {
common.Error("Failed to receive count response: %v", err)
os.Exit(1)
}

if msg.Type == proc.MessageTypeResponse && msg.ID == "RPCGetRemoteCVECount" {
var resp map[string]interface{}
if err := msg.UnmarshalPayload(&resp); err == nil {
totalResults := int(resp["total_results"].(float64))
common.Info("Total CVEs in NVD database: %d", totalResults)
}
break
}

// Handle event messages
if msg.Type == proc.MessageTypeEvent {
var event map[string]interface{}
if err := msg.UnmarshalPayload(&event); err == nil {
eventType := event["event"]
if eventType != nil {
common.Debug("Event: %v", eventType)
}
}
}
}
}

common.Info("Demo complete!")
}
