import { describe, it, expect, beforeEach } from 'vitest';
import { rpcClient } from '../src/rpc-client.js';
import { assertRpcSuccess } from '../helpers/assertions.js';
import { KNOWN } from '../helpers/fixtures.js';

describe('CVE ETL', () => {
  beforeEach(async () => {
    // Reset database before each ETL test
    const manager = (globalThis as any).__V2E_SERVICE_MANAGER__;
    if (manager) {
      await manager.resetDatabase('cve');
    }
  });

  it('should fetch CVEs from remote service',
    { timeout: 60000 },
    async () => {
      // Use existing RPCFetchCVEs method from remote service
      // This fetches CVE data from NVD API
      const fetchResponse = await rpcClient.call(
        'RPCFetchCVEs',
        { start_index: 0, results_per_page: 5 }, // Small batch for speed
        'remote'
      );

      // The request should be accepted
      // Note: May fail due to rate limiting or network issues
      expect(fetchResponse).toBeDefined();
      expect(fetchResponse.retcode).toBeDefined();

      // If successful, we should have CVE data
      if (fetchResponse.retcode === 0) {
        const data = fetchResponse.payload as any;
        expect(data).toBeDefined();
        expect(Array.isArray(data.vulnerabilities)).toBe(true);
      }
      // If rate limited, that's also valid behavior
      else if (fetchResponse.message?.includes('rate limit')) {
        expect(true).toBe(true); // Expected behavior under load
      }
    }
  );

  it('should get CVE by ID from remote',
    { timeout: 30000 },
    async () => {
      // Use existing RPCGetCVEByID method
      const getResponse = await rpcClient.call(
        'RPCGetCVEByID',
        { cveId: KNOWN.CVE },
        'remote'
      );

      // Request should be processed
      expect(getResponse).toBeDefined();
      expect(getResponse.retcode).toBeDefined();

      // CVE may or may not exist in NVD
      // We verify the system handles both cases gracefully
      if (getResponse.retcode === 0) {
        const data = getResponse.payload as any;
        expect(data).toBeDefined();
      }
    }
  );

  it('should handle CVE listing from local after fetch attempt',
    { timeout: 60000 },
    async () => {
      // Try to fetch CVEs from remote (may fail due to rate limiting)
      await rpcClient.call(
        'RPCFetchCVEs',
        { start_index: 0, results_per_page: 3 },
        'remote'
      );

      // Wait a bit for any processing
      await new Promise(resolve => setTimeout(resolve, 5000));

      // Try to list CVEs from local service
      const listResponse = await rpcClient.call(
        'RPCListCVEs',
        { limit: 10 },
        'local'
      );

      await assertRpcSuccess(listResponse);

      const data = listResponse.payload as any;
      expect(Array.isArray(data.cves)).toBe(true);

      // We don't assert specific counts because:
      // - NVD API may be rate limited
      // - Database may be empty
      // - Network may be slow
      // We verify the system doesn't crash
    }
  );
});
