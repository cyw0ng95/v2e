import { describe, it, expect, beforeEach } from 'vitest';
import { rpcClient } from '../src/rpc-client.js';
import { assertRpcSuccess } from '../helpers/assertions.js';
import { KNOWN } from '../helpers/fixtures.js';

describe('CVE ETL', () => {
  beforeEach(async () => {
    // Reset database before each ETL test
    const manager = (globalThis as any).__V2E_SERVICE_MANAGER__;
    if (manager) {
      await manager.resetDatabase('cve');
    }
  });

  it('should trigger CVE fetch request',
    { timeout: 60000 },
    async () => {
      // Trigger CVE fetch - this queues the request
      const fetchResponse = await rpcClient.call(
        'RPCTriggerCVEFetch',
        { cveId: KNOWN.CVE },
        'remote'
      );

      // The request to trigger should succeed
      await assertRpcSuccess(fetchResponse);

      // Note: We're testing that the ETL system accepts the request
      // The actual fetch happens asynchronously and may:
      // - Succeed if CVE exists
      // - Fail if CVE doesn't exist
      // - Fail due to rate limiting
      // We verify the request was accepted, not the result
    }
  );

  it('should trigger CVE year fetch with limit',
    { timeout: 120000 },
    async () => {
      const year = 2024;

      // Trigger CVE year fetch with small limit for speed
      const fetchResponse = await rpcClient.call(
        'RPCTriggerCVEYearFetch',
        { year, limit: 3 }, // Very small limit
        'remote'
      );

      // The request should be accepted
      await assertRpcSuccess(fetchResponse);

      // Wait some time for processing (may or may not complete)
      await new Promise(resolve => setTimeout(resolve, 10000));

      // Try to list CVEs - may have data if fetch succeeded
      const listResponse = await rpcClient.call(
        'RPCListCVEs',
        { limit: 10 },
        'local'
      );

      await assertRpcSuccess(listResponse);

      const data = listResponse.payload as any;
      expect(Array.isArray(data.cves)).toBe(true);

      // We don't assert specific counts because:
      // - NVD API may be rate limited
      // - Network may be slow
      // - CVEs may not exist yet
      // We verify the system doesn't crash
    }
  );
});
